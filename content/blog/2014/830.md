+++
title = "ngingx访问限制和iptables简单使用"
date = "2014-10-14T02:18:34+08:00"
tags = ["hdfs","2pc"]
categories = ["linux 应用"]
banner = "img/banners/banner-2.jpg"
draft = false
author = "helight"
authorlink = "https://helight.cn"
summary = ""
keywords = ["hdfs","2pc"]
+++

<div>为了方便安装了一个phpmyadmin，结果公司扫描了之后说要做一些安全限制，主要还是用到nginx的访问限制和iptables，这里稍微做一下记录
<div></div>
<div>nginx的限制较为简单，在server中添加对phpmyadmin的限制即可</div>
<div>

location ~* /phpmyadmin/ {

allow 192.168.3.0/24;

deny all;
<div>}</div>
</div>
<div></div>
<div>主要还是记录一下iptables的简单使用：</div>
<div><strong>1、查看</strong>
iptables -vL –line-number</div>
<div></div>
<div>-v 输出详细信息，包含通过该规则的数据包数量，总字节数及相应的网络接口</div>
<div>-L 查看当前表的所有规则，默认查看的是filter表，如果要查看NAT表，可以加上-t NAT参数</div>
<div>–line-number 显示规则的序列号，这个参数在删除或修改规则时会用到</div>
<div>简单查看也可以使用iptables -L</div>
<div>[root@Helight]# iptables -nvL --line-number
Chain INPUT (policy ACCEPT 301 packets, 1767K bytes)
num   pkts bytes target     prot opt in     out     source               destination
1      140 11760 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0
2        0     0 ACCEPT     tcp  --  eth1   *       192.168.3.0/24        0.0.0.0/0          multiport dports 22</div>
<div>3        0     0 ACCEPT     tcp  --  eth1   *       192.168.1.0/24       0.0.0.0/0           multiport dports 22</div>
<div>4      532 28698 ACCEPT     tcp  --  eth1   *       0.0.0.0/0            0.0.0.0/0           tcp dpt:80
5       83 42547 ACCEPT     tcp  --  eth1   *       192.168.1.160         0.0.0.0/0           tcp spt:3306</div>
<div></div>
<div>...</div>
<div>[root@Helight]# iptables -L</div>
<div>Chain INPUT (policy ACCEPT)
target     prot opt source               destination
ACCEPT     icmp --  anywhere             anywhere
ACCEPT     tcp  --  192.168.3.0/24        anywhere            multiport dports 22</div>
<div>ACCEPT     tcp  --  192.168.1.0/24       anywhere            multiport dports 22</div>
<div>ACCEPT     tcp  --  anywhere             anywhere            tcp dpt:http
ACCEPT     tcp  --  192.168.1.160         anywhere            tcp spt:mysql</div>
<div></div>
<div><strong>2、添加</strong>
添加规则有两个参数：-A和-I。其中-A是添加到规则的末尾；-I可以插入到指定位置，没有指定位置的话默认插入到规则的首部。</div>
<div></div>
<div>

在INPUT链上添加一条规则到尾部：
<pre>[root@Helight]# iptables -A INPUT -s 192.168.3.5 -j DROP</pre>
再在OUTPUT链上插入一条规则到第三行，将行数直接写到规则链的后面：
<pre>[root@Helight]# iptables -I OUTPUT 3 -s 192.168.3.3 -j DROP</pre>
</div>
<div>

<strong>3、删除</strong>
删除用-D参数

删除之前添加的规则（iptables -A INPUT -s 192.168.3.5 -j DROP）：
<pre>[root@Helight]# iptables -D INPUT -s 192.168.3.5 -j DROP</pre>
有时候要删除的规则太长，删除时要写一大串，既浪费时间又容易写错，这时我们可以先使用–line-number找出该条规则的行号，再通过行号删除规则。

</div>
<div>

删除INPUT链上的第4行规则
<pre>[root@Helight]# iptables -D INPUT 4</pre>
<strong>4、修改</strong>
修改使用-R参数</div>
<div></div>
<div>

将INPUT链上的第4条规则改为ACCEPT：
<pre>[root@test ~]# iptables -R INPUT 4 -j ACCEPT</pre>
<pre></pre>
<pre>常用的一些规则：</pre>
<div>

1、多端口登录

iptables -A INPUT -i eth1 -p tcp -s 192.168.1.0/24 -m multiport --dport 22,23 -j ACCEPT

iptables -A OUTPUT -o eth1 -p tcp -d 192.168.1.0/24 -m multiport --sport 22,23 -j ACCEPT

<span style="font-size: small;"> </span>
<div>2、允许eth1网口上对webserver 端口的TCP访问（如80、443端口）。</div>
iptables -A INPUT -i eth1 -p tcp --dport 80 -j ACCEPT

iptables -A OUTPUT -o eth1 -p tcp --sport 80 -j ACCEPT

</div>
<div>

3、允许phpmyadmin对其DB的访问（如DB的ip是10.10.10.10，DB端口是3306）。

</div>
<div>iptables -A INPUT -i eth1 -p tcp -s 192.168.1.160 --sport 3306 -j ACCEPT</div>
<div>iptables -A OUTPUT -o eth1 -p tcp -d 192.168.1.160 --dport 3306 -j ACCEPT</div>
<div>

4、允许ping
<div>iptables -A INPUT -p icmp -j ACCEPT</div>
<div>iptables -A OUTPUT -p icmp -j ACCEPT</div>
<div></div>
</div>
<div>

5、禁止来自eth1网口上的其他访问。

iptables -A INPUT -i eth1 -j DROP

iptables -A OUTPUT -o eth1 -j DROP

</div>
</div>
</div>